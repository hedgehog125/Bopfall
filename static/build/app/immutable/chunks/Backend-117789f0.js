import{b as J,c as d}from"./singletons-0c0466c6.js";const L=e=>(e[e.length-1]=="/"&&(e=e.slice(0,e.length-1)),J+"/"+e);d.disable_scroll_handling;const S=d.goto;d.invalidate;d.prefetch;d.prefetch_routes;d.before_navigate;d.after_navigate;const K={mime:e=>{const t=e.headers.get("content-type");return t==null?"":t.split(";")[0]}},w={url:e=>{S(e)},originalPage:e=>{let n=new URL(location.href).searchParams.get("returnTo");n==null&&(n=""),S(L(n))},temporaryPage:e=>{const t=new URL(location.href);t.searchParams.set("returnTo",t.pathname),t.pathname=L(e),S(t)},anotherTemporary:e=>{const t=new URL(location.href);t.pathname=L(e),S(t)}},v={readParrelel:async(e,t)=>{let n={},r=[];for(let[a,o]of Object.entries(t))for(let s of o)r.push((async c=>{n[s]=await e.get(a,s)})());return await Promise.all(r),n},writeParrelel:async(e,t,n=!1,r)=>{let a=[];for(let[o,s]of Object.entries(t))for(let[c,i]of Object.entries(s))a.push((async f=>{if(r){let I=r.objectStore(o);n?await I.put(i,c):await I.add(i,c)}else n?await e.put(o,i,c):await e.add(o,i,c)})());await Promise.all(a)}},$=(e,t)=>t.some(n=>e instanceof n);let M,U;function H(){return M||(M=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function G(){return U||(U=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const A=new WeakMap,R=new WeakMap,V=new WeakMap,N=new WeakMap,_=new WeakMap;function Q(e){const t=new Promise((n,r)=>{const a=()=>{e.removeEventListener("success",o),e.removeEventListener("error",s)},o=()=>{n(u(e.result)),a()},s=()=>{r(e.error),a()};e.addEventListener("success",o),e.addEventListener("error",s)});return t.then(n=>{n instanceof IDBCursor&&A.set(n,e)}).catch(()=>{}),_.set(t,e),t}function X(e){if(R.has(e))return;const t=new Promise((n,r)=>{const a=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",s),e.removeEventListener("abort",s)},o=()=>{n(),a()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),a()};e.addEventListener("complete",o),e.addEventListener("error",s),e.addEventListener("abort",s)});R.set(e,t)}let j={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return R.get(e);if(t==="objectStoreNames")return e.objectStoreNames||V.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return u(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function Y(e){j=e(j)}function Z(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const r=e.call(T(this),t,...n);return V.set(r,t.sort?t.sort():[t]),u(r)}:G().includes(e)?function(...t){return e.apply(T(this),t),u(A.get(this))}:function(...t){return u(e.apply(T(this),t))}}function q(e){return typeof e=="function"?Z(e):(e instanceof IDBTransaction&&X(e),$(e,H())?new Proxy(e,j):e)}function u(e){if(e instanceof IDBRequest)return Q(e);if(N.has(e))return N.get(e);const t=q(e);return t!==e&&(N.set(e,t),_.set(t,e)),t}const T=e=>_.get(e);function ee(e,t,{blocked:n,upgrade:r,blocking:a,terminated:o}={}){const s=indexedDB.open(e,t),c=u(s);return r&&s.addEventListener("upgradeneeded",i=>{r(u(s.result),i.oldVersion,i.newVersion,u(s.transaction))}),n&&s.addEventListener("blocked",()=>n()),c.then(i=>{o&&i.addEventListener("close",()=>o()),a&&i.addEventListener("versionchange",()=>a())}).catch(()=>{}),c}const te=["get","getKey","getAll","getAllKeys","count"],ne=["put","add","delete","clear"],k=new Map;function x(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(k.get(t))return k.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,a=ne.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(a||te.includes(n)))return;const o=async function(s,...c){const i=this.transaction(s,a?"readwrite":"readonly");let f=i.store;return r&&(f=f.index(c.shift())),(await Promise.all([f[n](...c),a&&i.done]))[0]};return k.set(t,o),o}Y(e=>({...e,get:(t,n,r)=>x(t,n)||e.get(t,n,r),has:(t,n)=>!!x(t,n)||e.has(t,n)}));class l extends Error{constructor(t){super(t),P||(F(oe[t],void 0,!0),P=!1)}}const O=async(e=!0)=>{if(g.init==null){const t=await W();if(e&&!t)throw new l("LoginNeeded")}},E=async(e,t)=>{if(p==null)throw new l("NoServerURL");let n;try{n=await fetch(p+e,t)}catch{throw new l("Network")}if(!n.ok)throw new l(await n.text());return n},y=e=>{P=!1},re="A unhandled error occurred",oe={Unknown:"Unknown error",Network:"Network error",CantConnect:"Unable to connect to the sever (CORS?)",NotBopfall:"Not a bopfall server",StartFailed:"Server failed to start",IncorrectPassword:"Incorrect password",IncorrectSetup:"Wrong setup code",NoServerURL:re},g={init:null,check:null},B={check:-1};let F;const se=e=>{F=e};let P=!1;const ae=e=>{P=!0};let p,m,h;const ie=e=>{if(e.endsWith("/")&&(e=e.slice(0,-1)),e==p||e==m)return g.check;m=e;const t=(async n=>{B.check=0;let r;try{r=await fetch(m+"/info")}catch(a){throw console.log(a),new l("CantConnect")}if(K.mime(r)!="application/json")throw new l("NotBopfall");try{r=await r.json()}catch{throw new l("NotBopfall")}if(r.type!="Bopfall")throw new l("NotBopfall");if(r.status=="error")throw new l("StartFailed");B.check++;try{r=await fetch(m+"/waitUntilStart")}catch{throw new l("Network")}if(r.ok)r.text();else throw new l("StartFailed");p=m,console.log("B"),B.check++,y()})();return g.check=t,t};let C;const W=(e=!1,t=!1,n=!1)=>{const r=(async a=>{C=await ee("bopfall",1,{upgrade:async(f,I,le,z)=>{f.createObjectStore("files"),f.createObjectStore("metadata"),f.createObjectStore("misc"),await v.writeParrelel(f,{misc:{serverURL:null,session:null,metaVersionStored:-1,versionStored:-1,wasUpgradingTo:-1,knownVersion:-1}},!1,z)}});const o=await v.readParrelel(C,{misc:["serverURL","session","metaVersionStored"]});p=o.serverURL,h=o.session;const s=e?o.session!=null:o.metaVersionStored!=-1||o.session!=null,c=o.metaVersionStored==-1;let i=!1;return s?t&&(await b.initialConfig.status.finished()?w.originalPage():n||w.anotherTemporary("initial-setup"),i=!0):t||(w.temporaryPage("login"),i=!0),s&&(i||c&&(await b.initialConfig.status.finished()||n||w.anotherTemporary("initial-setup"))),y(),s})();return g.init=r,r},ce=async(e,t)=>{await O(),t==null&&(t=await b.password.status.set()),h=(await D.postJSON("/login",{password:e})).session,await v.writeParrelel(C,{misc:{serverURL:p,session:h}},!0),await b.initialConfig.status.finished()?w.originalPage():w.anotherTemporary("initial-setup"),y()},D={getText:async e=>await(await E(e,{headers:{Authorization:"sessionid "+h}})).text(),getJSON:async e=>await(await E(e,{headers:{Authorization:"sessionid "+h}})).json(),getBool:async(e,t=!1)=>{const n=await D.getText(e);if(n=="null"){if(t)throw new l("BoolIsNull");return null}return n==="true"},postJSON:async(e,t)=>await(await E(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"sessionid "+h},body:JSON.stringify(t)})).json()},b={password:{status:{set:async e=>{await O(!1);const t=await D.getBool("/password/status/set");return y(),t}}},initialConfig:{status:{finished:async e=>{await O(!1);const t=await D.getBool("/initialConfig/status/finished");return y(),t}}}},ue=Object.freeze(Object.defineProperty({__proto__:null,BackendError:l,tasks:g,progress:B,setToast:se,preventNextErrorToast:ae,changeServerURL:ie,init:W,login:ce,request:b},Symbol.toStringTag,{value:"Module"}));export{ue as b,ie as c,W as i,ce as l,se as s};
